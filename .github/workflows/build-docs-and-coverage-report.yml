name: Build Docs & Coverage Report

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
  workflow_dispatch: { }

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.152.2'
          extended: true

      - name: Diagnose Hugo modules
        run: |
          cd docs
          hugo version || true
          hugo mod graph || true
          go env || true

      - name: Build Hugo site
        env:
          HUGO_ENV: production
        run: |
          set -e
          cd docs
          rm -rf publish public
          hugo
          echo "After build, contents:"
          ls -la .
          echo "docs/publish listing (if exists):"
          [ -d publish ] && ls -la publish || echo "docs/publish missing"
          echo "docs/public listing (if exists):"
          [ -d public ] && ls -la public || echo "docs/public missing"

      - name: Merge coverage-report into built site
        run: |
          set -e
          # Determine built site dir (prefer docs/publish then docs/public)
          if [ -f docs/publish/index.html ]; then
            SITE_DIR="docs/publish"
          elif [ -f docs/public/index.html ]; then
            SITE_DIR="docs/public"
          else
            echo "No index.html in docs/publish or docs/public. Aborting."
            find docs -maxdepth 3 -type f -name index.html || true
            exit 1
          fi
          echo "Using site dir: $SITE_DIR"
          mkdir -p /tmp/publish_copy
          rsync -a --delete "$SITE_DIR/"/ /tmp/publish_copy/
          if [ -d "docs/coverage-report" ]; then
            echo "Merging coverage-report"
            mkdir -p /tmp/publish_copy/coverage-report
            rsync -a --delete docs/coverage-report/ /tmp/publish_copy/coverage-report/
          fi
          echo "Resulting preserved copy:"
          find /tmp/publish_copy -maxdepth 3 -type f | head -n 50
          [ -f /tmp/publish_copy/index.html ] || { echo "Missing /tmp/publish_copy/index.html"; exit 1; }

      - name: Deploy to gh-pages
        env:
          GIT_COMMIT_MESSAGE: "Deploy docs from main: $GITHUB_SHA"
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin

          if git ls-remote --exit-code --heads origin gh-pages; then
            if git show-ref --quiet refs/heads/gh-pages; then
              git checkout gh-pages
            else
              git checkout --track origin/gh-pages
            fi
          else
            git checkout --orphan gh-pages
          fi

          git rm -rf . || true
          git clean -fdx || true

          rsync -a --delete /tmp/publish_copy/ ./
          touch .nojekyll

          [ -f index.html ] || { echo "index.html missing at repo root"; ls -la; exit 1; }

          git add -A
          echo "Staged files:"
          git diff --cached --name-only || true
          STAGED_COUNT=$(git diff --cached --name-only | wc -l)

          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "Initial commit on orphan branch."
          fi

          if [ "$STAGED_COUNT" -gt 0 ]; then
            git commit -m "$GIT_COMMIT_MESSAGE"
            git push --force --set-upstream origin gh-pages
          else
            echo "No changes to commit."
            exit 0
