name: Publish TestReports

on:
  push:
    branches: [ main ]
    paths:
      - '**/TestReports/**'
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Debug - list TestReports files
        run: |
          echo "Listing files under any TestReports path (if present):"
          find . -type f -path '*/TestReports/*' -print || true

      - id: find
        name: Find TestReports directory
        run: |
          REPORT_DIR=$(find . -type d -name 'TestReports' -print -quit || true)
          echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_OUTPUT

      - id: prepare
        name: Prepare publish directory
        run: |
          REPORT_DIR="${{ steps.find.outputs.REPORT_DIR }}"
          if [ -z "$REPORT_DIR" ]; then
            echo "No TestReports directory found. Skipping publish."
            echo "publish_path=" >> $GITHUB_OUTPUT
            exit 0
          fi
          FIRST_FILE=$(find "$REPORT_DIR" -type f -print -quit || true)
          if [ -z "$FIRST_FILE" ]; then
            echo "TestReports directory exists but is empty. Skipping publish."
            echo "publish_path=" >> $GITHUB_OUTPUT
            exit 0
          fi
          rm -rf publish
          mkdir -p publish
          cp -r "$REPORT_DIR"/. publish/

          # If publish contains a single top-level directory which itself contains index.html,
          # move its contents to the publish root so Pages serves index at site root.
          TOP_DIR_COUNT=$(find publish -mindepth 1 -maxdepth 1 -type d | wc -l)
          if [ "$TOP_DIR_COUNT" -eq 1 ]; then
            CHILD_DIR=$(find publish -mindepth 1 -maxdepth 1 -type d -print -quit)
            if [ -f "$CHILD_DIR/index.html" ]; then
              echo "Detected single child dir $CHILD_DIR containing index.html; flattening to publish root"
              mv "$CHILD_DIR"/* publish/ || true
              rm -rf "$CHILD_DIR"
            fi
          fi

          echo "publish_path=publish" >> $GITHUB_OUTPUT

      - name: Debug - show prepared publish files
        if: steps.prepare.outputs.publish_path != ''
        run: |
          echo "Files prepared for publish:"
          find publish -maxdepth 5 -type f -print || true

      - name: Upload Pages artifact
        if: steps.prepare.outputs.publish_path != ''
        uses: actions/upload-pages-artifact@v2
        with:
          path: ${{ steps.prepare.outputs.publish_path }}

      - name: Deploy to GitHub Pages
        if: steps.prepare.outputs.publish_path != ''
        uses: actions/deploy-pages@v2
